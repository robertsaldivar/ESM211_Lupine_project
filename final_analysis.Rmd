---
title: "final_analysis"
author: "Kyle Monper"
date: "March 6, 2020"
output:
  word_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F, echo = F)
```


```{r}
library(tidyverse)

yearlydata <- read_csv("yearlydata.csv")
all_data <- read_csv("all_data.csv")
precip <- read_csv("water_year.csv") %>% 
  select(-year)
```


### model
```{r function}


## exogenous drivers -- should be generated on a microhabitat/treatment basis
# d <-  # death rate of seeds (how can we figure this out!?!)
# f <-  # fecundity - note: need to find a way to model this so we can randomize based on some known mean and sd
# g <-  # germination rate -- (same note^^^)

fecund_model <- glm(seedpods ~ decrain + janrain + febrain + marchrain + aprilrain + mayrain + cage, data = all_data, family = poisson) 
summary(fecund_model)


#!!!!!!! NOTE: still need to update this based on new bank data
germ_model <- glm(cbind(germination, bank - germination) ~ decrain + janrain, data = yearlydata, family=binomial())
summary(germ_model)

sim_lupin <- function(planted, cage_type) {
  
    
  N <- vector(length = 5)
  b <- vector(length = 6)
  b[1] <- planted
  
  d <- .17
  
  ## randomize years to be selected
  years <- ceiling(runif(5, 0, 13))
  
  ## get random precip years + add cage type to df to be used w/in predict
  precip$cage <- cage_type
  precip_year <- precip[years,]
  
  f <- predict(fecund_model, precip_year, type = "response") * 2 # x2 for number of sees per pod
  f[f<0] <- 0

  
  ## need to figure out the proper distribution for these ( for each treatment type?)
  g <- predict(germ_model, precip_year, type = "response")
  g[g<0] <- 0

  for(year in 1:5) {
    N[year] <- b[year]* (1 - d) * g[year]
    b[year + 1] <- (N[year] * f[year]) + (b[year] - N[year])
  }
  
  res <- data.frame(year = seq(1,5), pop = N[1:5], bank = b[1:5])
  res$scenario <- planted
  
  return(res)
  
}

test <- sim_lupin(1000, "Big")
test

```


# single run - big cage
```{r simulate}
### how to choose necessary planting

planted <- seq(1000, 6000, 100)

sim_list <- lapply(planted, sim_lupin, "Big")

sim <- bind_rows(sim_list)
seeds_needed <- sim %>% 
  filter(year == 5 & pop > 5000) %>% 
  filter(scenario == min(scenario)) %>% ### do we want to select the min or average here?
  select(scenario) %>% 
  as.numeric()


## next to do: monte-carlo simulation to see how randomness effects each of these



# plot the trend
ggplot(sim, aes(year, pop, group = as.factor(scenario), color = as.factor(scenario))) +
  geom_line() +
  geom_hline(yintercept = 5000, linetype = "dashed", size = 1) +
  theme(legend.position = "none")


```


# montecarlo run big cage
```{r monte carlo}
### this is for if we know the mean and sd for death, fecundity, and germination
## if any of these are unknown, see the MonteCarlo simulation in ./MonteCarlo.Rmd

num_trials <- 1000

trial <- vector(length = num_trials)

planted <- seq(1000, 6000, 100)
suppressWarnings({
  for (i in 1:length(trial)) {
  sim_list <- lapply(planted, sim_lupin, "Big")

  sim <- bind_rows(sim_list)
  
  seeds_needed <- sim %>% 
    filter(year == 5 & pop > 5000) %>% 
    filter(scenario == min(scenario)) %>% ### do we want to select the min or average here?
    select(scenario) %>% 
    as.numeric()
  
  trial[i] <- seeds_needed
  
  # mark progress (for sanity's sake)
  if(i%%100 == 0) {
    print(paste(i/length(trial)))
  }

  
}
  
})


hist(trial, main = "big cage treatment")

# mean and sd of seeds needed (is the mode more appropriate here?)
mean(trial)
sd(trial)


### once we get this mean, we can then frame the question in another way:
## if we plant X# of seeds, what is the probability of getting to N=5000 by year 5
```



# montecarlo run small cage
```{r monte carlo small}
### this is for if we know the mean and sd for death, fecundity, and germination
## if any of these are unknown, see the MonteCarlo simulation in ./MonteCarlo.Rmd

suppressWarnings({ 
  num_trials <- 1000

trial <- vector(length = num_trials)

planted <- seq(5000, 20000, 100)

for (i in 1:length(trial)) {
  sim_list <- lapply(planted, sim_lupin, "small")

  sim <- bind_rows(sim_list)
  
  seeds_needed <- sim %>% 
    filter(year == 5 & pop > 5000) %>% 
    filter(scenario == min(scenario)) %>% ### do we want to select the min or average here?
    select(scenario) %>% 
    as.numeric()
  
  trial[i] <- seeds_needed
  
  # mark progress (for sanity's sake)
  if(i%%100 == 0) {
    print(paste(i/length(trial)))
  }

  
}})


hist(trial, main = "small cage treatment")

# mean and sd of seeds needed (is the mode more appropriate here?)
mean(trial, na.rm = T)
sd(trial, na.rm = T)


### once we get this mean, we can then frame the question in another way:
## if we plant X# of seeds, what is the probability of getting to N=5000 by year 5
```

# montecarlo run big cage
```{r monte carlo no}
### this is for if we know the mean and sd for death, fecundity, and germination
## if any of these are unknown, see the MonteCarlo simulation in ./MonteCarlo.Rmd

num_trials <- 100

trial <- vector(length = num_trials)

planted <- seq(100000, 300000, 20000)

suppressWarnings({ 
  for (i in 1:length(trial)) {
  sim_list <- lapply(planted, sim_lupin, "none")

  sim <- bind_rows(sim_list)
  
  seeds_needed <- sim %>% 
    filter(year == 5 & pop > 5000) %>% 
    filter(scenario == min(scenario)) %>% ### do we want to select the min or average here?
    select(scenario) %>% 
    as.numeric()
  
  trial[i] <- seeds_needed
  
  # mark progress (for sanity's sake)
  if(i%%100 == 0) {
    print(paste(i/length(trial)))
  }

  
}})


hist(trial, main = "no cage treatment")

# mean and sd of seeds needed (is the mode more appropriate here?)
mean(trial, na.rm = T)
sd(trial, na.rm = T)


### once we get this mean, we can then frame the question in another way:
## if we plant X# of seeds, what is the probability of getting to N=5000 by year 5
```


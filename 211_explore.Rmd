---
title: '211'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

To do list:

data cleaning 
- wrangle/ figure out whats going on with 2016 data
- fix variable names (see "clean code chunk" ~line 75)

Modeling:
- model fecundity - get mean and sd based on environmental variables + treatment variables
- model germination rate - get mean and sd based on environmental variables + treatment variables?
- figure out how to deal w/ seed survival/death rate (monte carlo?)


```{r read data}
library(tidyverse)
library(janitor)
library(readxl)


# read in metadate for easy reference
metadata_plot <- read_excel("data_scripts/BLEA_LUNI_metadata.xlsx", sheet = 1)
metadata_idnv <- read_excel("data_scripts/BLEA_LUNI_metadata.xlsx", sheet = 2)


### read in yearly data 
#~ remove blank rows 
#~ add explicit year

### 2016 data is wonky (different columns, and values w/in columns.. & has the multiple seeding starts)
nipomo2016 <- read_csv("data_scripts/nipomo2016.csv") %>%
  rename("seedpods" = "seeds") %>%
  rename("scarification" = "scar") %>%
  clean_names(case = c("snake"))
nipomo2016 <- nipomo2016[!apply(is.na(nipomo2016) | nipomo2016 == "", 1, all),]
nipomo2016$year <- "2016"


nipomo2017 <- read_csv("data_scripts/nipomolupine2017.csv") %>% 
  rename("seedpods" = "seeds") %>%
  clean_names(case = c("snake"))
nipomo2017 <- nipomo2017[!apply(is.na(nipomo2017) | nipomo2017 == "", 1, all),] # remove blank rows
nipomo2017$year <- "2017"



nipomo2018 <- read_csv("data_scripts/nipomolupine2018.csv")  %>% 
  rename("seedpods" = "seeds") %>%
  clean_names(case = c("snake"))
nipomo2018 <- nipomo2018[!apply(is.na(nipomo2018) | nipomo2018== "", 1, all),]
nipomo2018$year <- "2018"


nipomo2019 <- read_csv("data_scripts/nipomolupine2019.csv") %>%
  clean_names(case = c("snake"))
nipomo2019 <- nipomo2019[!apply(is.na(nipomo2019) | nipomo2019 == "", 1, all),]
nipomo2019$year <- "2019"


yearlydata <-read_csv("data_scripts/nipomo5years.csv")
yearlydata$current.year <- as.factor(as.character(yearlydata$current.year))



#### bind all together 
bind_16_19 <- bind_rows(nipomo2016, nipomo2019)
bind_17_18 <- bind_rows(nipomo2017, nipomo2018)
all_data <- bind_rows(bind_17_18, bind_16_19)
all_data$year <- as.factor(all_data$year)

#Due to the 2016 data being different it might be a good idea to clean up the data a little more but all of the seed pods are now together for each year.


```

```{r clean}
### need to clean attribute coding (e.g some years "no aspect" was recorded as "no.aspect", some was years had aspect as s, vs south)
# see:
unique(all_data$Slope) # steep and Steep
unique(all_data$Topo)
unique(all_data$Aspect) # South & south why 'small'?
# maybe others
```


### explore 
```{r general trend}

### count the number of individuals over time
pop_trend <- all_data %>% 
  group_by(year) %>% 
  summarise(
    count = length(unique(id))
  )

plot(pop_trend, main = "indviduals over time")


```

```{r germination}
### number of germinates over time
ggplot(yearlydata, aes(current.year, germination)) +
  geom_boxplot() + 
  labs(
    title = "# germinants per year across all plots"
  )

### germ ~ bank
ggplot(yearlydata, aes(bank, germination)) +
  geom_smooth(method = "lm") +
  geom_point(aes(color = current.year)) +
  labs(title = "germination as function of seedbank")

#### germ ~ slop/aspect + cage

ggplot(yearlydata, aes(current.year, germination)) +
  geom_boxplot(aes(color = cage)) +
  facet_wrap(~Slope) + 
  labs(
    title = "# germinants per year across plot, by slope"
  )

ggplot(yearlydata, aes(current.year, germination)) +
  geom_boxplot(aes(color = cage)) +
  facet_wrap(~Aspect) + 
  labs(
    title = "# germinants per year across plot, by aspect"
  )
```

```{r other traits}
 # what proportion of germinated individuals survive and bear seeds
ggplot(yearlydata, aes(current.year, proportionseeded)) +
  geom_boxplot() +
  facet_wrap(~cage)

# what is the fecundity?
# yearly average 
fecund <- all_data %>% 
  group_by(year) %>% 
  summarise(
    avg_pods = mean(seedpods, na.rm = T),
    sd = sd(seedpods, na.rm = T)
  )

seed_per_pod <- 2
total_avg_seed <- mean(fecund$avg_pods) * seed_per_pod
### next steps, what variables best predict fecundity?


# use geometric mean????

```


### conceptual model 
```{r function}


## exogenous drivers -- should be generated on a microhabitat/treatment basis
# d <-  # death rate of seeds (how can we figure this out!?!)
# f <-  # fecundity - note: need to find a way to model this so we can randomize based on some known mean and sd
# g <-  # germination rate -- (same note^^^)
  

sim_lupin <- function(planted) {
  
  N <- vector(length = 5)
  b <- vector(length = 6)
  b[1] <- planted
  
   ## need to figure out the proper distribution for these ( for each treatment type?)
  d <- rnorm(5, .2, .02)
  f <- rnorm(5, total_avg_seed, 4)
  g <- rnorm(5, .05, .005)
  ## if less than 0 turn to 0
  g[g<0] <- 0
  f[f<0] <- 0
  
  for(year in 1:5) {
    N[year] <- (b[year] - d[year])*g[year]
    b[year + 1] <- (N[year] * f[year]) + (b[year] - N[year])
  }
  
  res <- data.frame(year = seq(1,5), pop = N, bank = b[1:5])
  res$scenario <- planted
  
  return(res)
}
# example of 40 starting seeds
sim_lupin(40)

```

```{r simulate}
### how to choose necessary planting

planted <- seq(100, 10000, 100)

sim_list <- lapply(planted, sim_lupin)

sim <- bind_rows(sim_list)
seeds_needed <- sim %>% 
  filter(year == 5 & pop > 5000) %>% 
  filter(scenario == min(scenario)) %>% ### do we want to select the min or average here?
  select(scenario) %>% 
  as.numeric()


## next to do: monte-carlo simulation to see how randomness effects each of these



# plot the trend
ggplot(sim, aes(year, pop, group = as.factor(scenario), color = as.factor(scenario))) +
  geom_line() +
  geom_hline(yintercept = 5000, linetype = "dashed", size = 1) +
  theme(legend.position = "none")


```



```{r monte carlo}
### this is for if we know the mean and sd for death, fecundity, and germination
## if any of these are unknown, see the MonteCarlo simulation in ./MonteCarlo.Rmd

num_trials <- 100

trial <- vector(length = num_trials)

planted <- seq(1000, 20000, 100)

for (i in 1:length(trial)) {
  sim_list <- lapply(planted, sim_lupin)

  sim <- bind_rows(sim_list)
  
  seeds_needed <- sim %>% 
    filter(year == 5 & pop > 5000) %>% 
    filter(scenario == min(scenario)) %>% ### do we want to select the min or average here?
    select(scenario) %>% 
    as.numeric()
  
  trial[i] <- seeds_needed
  
  # mark progress (for sanity's sake)
  if(i%%100 == 0) {
    print(paste(i/length(trial)))
  }

  
}

hist(trial)

# mean and sd of seeds needed (is the mode more appropriate here?)
mean(trial)
sd(trial)


### once we get this mean, we can then frame the question in another way:
## if we plant X# of seeds, what is the probability of getting to N=5000 by year 5
```



scratch work
```{r}
#linear model example for germination
test <- lm(germination ~ som + ph + ec, data = yearlydata)
summary(test)


## how to assign a unique ID based on multiple attributes (for assigning plot ID if we want)
tmp <- all_data %>% 
  mutate(plot_ID = group_indices(., Slope, rep, Topo, cage, Scarification)) ## dont think this is the right group combo

# do all rep 1,2,etc means the same thing?
tmp <- filter(all_data, rep == 1)
# no.

```














